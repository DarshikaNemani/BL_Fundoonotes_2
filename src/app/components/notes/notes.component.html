<!-- Create note -->
<div class="note-form-container">
  <form [formGroup]="noteForm" (ngSubmit)="onSubmit()" class="note-form" [style.background-color]="selectedFormColor">
    <div class="form-input-row" *ngIf="!isExpanded">
      <input formControlName="description" placeholder="Take a note..." class="note-input" type="text"
        (focus)="expandForm()">

      <div class="form-icons">
        <button type="button" mat-icon-button aria-label="New list">
          <mat-icon>check_box</mat-icon>
        </button>
        <button type="button" mat-icon-button aria-label="New drawing">
          <mat-icon>brush</mat-icon>
        </button>
        <button type="button" mat-icon-button aria-label="New image">
          <mat-icon>image</mat-icon>
        </button>
      </div>
    </div>

    <div *ngIf="isExpanded" class="expanded-form">
      <input formControlName="title" placeholder="Title" class="note-title-input" type="text">

      <textarea formControlName="description" placeholder="Take a note..." class="note-textarea" rows="3"
        (blur)="onInputBlur()"></textarea>

      <div class="form-footer">
        <div class="form-actions">
          <button type="button" mat-icon-button aria-label="Remind me">
            <mat-icon>add_alert</mat-icon>
          </button>
          <button type="button" mat-icon-button aria-label="Collaborator">
            <mat-icon>person_add</mat-icon>
          </button>
          <button type="button" mat-icon-button aria-label="Color options" (click)="toggleFormColorPicker($event)">
            <mat-icon>palette</mat-icon>
          </button>
          <button type="button" mat-icon-button aria-label="Add image">
            <mat-icon>image</mat-icon>
          </button>
          <button type="button" mat-icon-button aria-label="Archive">
            <mat-icon>archive</mat-icon>
          </button>
        </div>
        <button type="submit" mat-button class="close-btn"
          [disabled]="!noteForm.value.title?.trim() && !noteForm.value.description?.trim()">
          Close
        </button>
      </div>
    </div>
  </form>

  <!-- Color Picker -->
  <div class="color-picker-popup form-color-picker" *ngIf="showFormColorPicker" (click)="$event.stopPropagation()">
    <div class="color-grid">
      <div class="color-option default-color" (click)="selectFormColor('#ffffff')"
        [class.selected]="selectedFormColor === '#ffffff'">
        <mat-icon>format_color_reset</mat-icon>
      </div>

      <div *ngFor="let color of solidColors" class="color-option" [style.background-color]="color"
        (click)="selectFormColor(color)" [class.selected]="selectedFormColor === color">
      </div>
    </div>
  </div>
</div>

<!-- Notes grid -->
<div class="notes-container" *ngIf="activeNotes.length > 0">
  <div class="notes-masonry">
    <div *ngFor="let note of activeNotes; trackBy: trackByNoteId" class="note-card-wrapper"
      [class.has-color-picker]="showNoteColorPicker && selectedNoteForColor?.id === note.id">

      <div class="note-card" [class.editing]="isEditing && editNoteId === note.id"
        [style.background-color]="note.color || '#ffffff'" (click)="onNoteClick(note)">

        <div *ngIf="!(isEditing && editNoteId === note.id)" class="note-content">
          <div class="note-body">
            <div class="note-header" *ngIf="note.title">
              <h3 class="note-title">{{ note.title }}</h3>
            </div>
            <div class="note-description" *ngIf="note.description">
              {{ note.description }}
            </div>
          </div>

          <div class="note-actions-bottom">
            <button mat-icon-button class="action-btn" aria-label="Remind me" (click)="$event.stopPropagation()">
              <mat-icon>add_alert</mat-icon>
            </button>
            <button mat-icon-button class="action-btn" aria-label="Collaborator" (click)="$event.stopPropagation()">
              <mat-icon>person_add</mat-icon>
            </button>
            <button mat-icon-button class="action-btn" aria-label="Color options"
              (click)="toggleNoteColorPicker($event, note)">
              <mat-icon>palette</mat-icon>
            </button>
            <button mat-icon-button class="action-btn" aria-label="Add image" (click)="$event.stopPropagation()">
              <mat-icon>image</mat-icon>
            </button>
            <button mat-icon-button class="action-btn" aria-label="Archive"
              (click)="onArchiveNote(note.id!); $event.stopPropagation()">
              <mat-icon>archive</mat-icon>
            </button>
            <button mat-icon-button class="action-btn" aria-label="Delete note"
              (click)="onDeleteNote(note.id); $event.stopPropagation()">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>

        <div *ngIf="isEditing && editNoteId === note.id" class="edit-content" (click)="$event.stopPropagation()">
          <div class="edit-body">
            <input [(ngModel)]="editTitle" placeholder="Title" class="edit-title-input" type="text"
              (keydown.enter)="onSaveNote(note.id)" (keydown.escape)="onCancelEdit()">

            <textarea [(ngModel)]="editDescription" placeholder="Take a note..." class="edit-description-textarea"
              rows="4" (keydown.escape)="onCancelEdit()"></textarea>
          </div>

          <div class="edit-actions-bottom">
            <div class="edit-action-buttons">
              <button type="button" mat-icon-button aria-label="Remind me">
                <mat-icon>add_alert</mat-icon>
              </button>
              <button type="button" mat-icon-button aria-label="Collaborator">
                <mat-icon>person_add</mat-icon>
              </button>
              <button type="button" mat-icon-button aria-label="Color options"
                (click)="toggleNoteColorPicker($event, note)">
                <mat-icon>palette</mat-icon>
              </button>
              <button type="button" mat-icon-button aria-label="Add image">
                <mat-icon>image</mat-icon>
              </button>
              <button type="button" mat-icon-button aria-label="Archive" (click)="onArchiveNote(note.id!)">
                <mat-icon>archive</mat-icon>
              </button>
              <button type="button" mat-icon-button aria-label="Delete note" (click)="onDeleteNote(note.id)">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
            <button mat-button (click)="onSaveNote(note.id)" class="close-btn">
              Close
            </button>
          </div>
        </div>
      </div>

      <div class="color-picker-popup note-color-picker"
        *ngIf="showNoteColorPicker && selectedNoteForColor?.id === note.id" (click)="$event.stopPropagation()">
        <div class="color-grid">
          <div class="color-option default-color" (click)="changeNoteColor(note, '#ffffff')"
            [class.selected]="note.color === '#ffffff' || !note.color">
            <mat-icon>format_color_reset</mat-icon>
          </div>

          <div *ngFor="let color of solidColors" class="color-option" [style.background-color]="color"
            (click)="changeNoteColor(note, color)" [class.selected]="note.color === color">
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="empty-state" *ngIf="activeNotes.length === 0 && !isLoading">
  <mat-icon class="empty-icon">lightbulb</mat-icon>
  <p class="empty-message">Notes you add appear here</p>
</div>

<div class="loading-state" *ngIf="isLoading">
  <mat-spinner diameter="40"></mat-spinner>
</div>